C51 COMPILER V9.54   UART                                                                  06/16/2015 09:53:32 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN uart.obj
COMPILER INVOKED BY: d:\Keil_v5\C51\BIN\C51.EXE Source\uart.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\电机控制) DEBUG OBJECTE
                    -XTEND PRINT(.\uart.lst) TABS(2) OBJECT(uart.obj)

line level    source

   1          /*
   2          版权声明：
   3          WIFI机器人网・机器人创意工作室版权所有 www.wifi-robots.com
   4          您可以任意修改本程序，并应用于自行研发的智能小车机器人及其他电子产品上，但是禁止用于商业牟利。
   5          By WIFI机器人网・机器人创意工作室
   6          */
   7          
   8          #include "uart.h"
   9          #include <stdio.h>
  10          #include "motor.h"
  11          #include "steer.h"
  12          #include "mem.h"
  13          #include "IR.h"
  14          #include "timer.h"
  15          #include "OLED12864.h"
  16          
  17          extern uint16 se_timer[8];
  18          uint8 xdata buffer[3];
  19          uint8 rec_flag=0; //等于0等待接受 等于1正在接受 
  20          extern uchar IR_Type;  
  21          extern uchar IR_Num;
  22          extern uchar Cruising_Flag;
  23          extern uint16 Uart_timeout_count;
  24          
  25          
  26          void UART_init(void)
  27          {
  28   1        PCON |= 0x80;   //使能波特率倍速位SMOD
  29   1        SCON = 0x50;    //8位数据,可变波特率
  30   1        BRT = RELOAD_COUNT;   //设定独立波特率发生器重装值
  31   1        AUXR |= 0x04;   //独立波特率发生器时钟为Fosc,即1T
  32   1        AUXR |= 0x01;   //串口1选择独立波特率发生器为波特率发生器
  33   1        AUXR |= 0x10;   //启动独立波特率发生器
  34   1        ES      =   1;    //允许串口中断
  35   1          EA      =   1;    //开总中断
  36   1        TI      =   1;  
  37   1        EX0=0;
  38   1        EX1=0;
  39   1      }
  40          
  41          void UART_send_byte(uint8 byte)
  42          {
  43   1        ES     =   0;  //关串口中断
  44   1          TI     =   0;  //清零串口发送完成中断请求标志
  45   1          SBUF   =   byte;
  46   1          while(TI ==0); //等待发送完成
  47   1          TI     =   1;  //清零串口发送完成中断请求标志
  48   1          ES     =   1;  //允许串口中断
  49   1      }
  50          
  51          void UART_send(uint8 *Buffer, uint8 Length)
  52          {
  53   1        while(Length != 0)
  54   1        {
C51 COMPILER V9.54   UART                                                                  06/16/2015 09:53:32 PAGE 2   

  55   2          UART_send_byte(*Buffer);
  56   2          Buffer++;
  57   2          Length--;
  58   2        }
  59   1      
  60   1      }
  61          
  62          void Communication_Decode(void)  
  63          { 
  64   1        uint8 i;
  65   1      
  66   1        if(buffer[0]==0x00)
  67   1        {
  68   2          switch(buffer[1])
  69   2          {
  70   3            case 0x01:MOTOR_GO_FORWARD; return;
  71   3            case 0x02:MOTOR_GO_BACK;    return;
  72   3            case 0x03:MOTOR_GO_LEFT;    return;
  73   3            case 0x04:MOTOR_GO_RIGHT;   return;
  74   3            case 0x00:MOTOR_GO_STOP;    return;
  75   3            default: return;
  76   3          } 
  77   2        }
  78   1        else if(buffer[0]==0x01)
  79   1        {
  80   2          if(buffer[2]>180)
  81   2            return;
  82   2          switch(buffer[1])
  83   2          {
  84   3            case 0x01:se_timer[0]=buffer[2]; return;
  85   3            case 0x02:se_timer[1]=buffer[2]; return;
  86   3            case 0x03:se_timer[2]=buffer[2]; return;
  87   3            case 0x04:se_timer[3]=buffer[2]; return;
  88   3            case 0x05:se_timer[4]=buffer[2]; return;
  89   3            case 0x06:se_timer[5]=buffer[2]; return;
  90   3            case 0x07:se_timer[6]=buffer[2]; return;
  91   3            case 0x08:se_timer[7]=buffer[2]; return;
  92   3            default : return;
  93   3          }
  94   2        }
  95   1        else if(buffer[0]==0x04)    //车灯控制使用灌电流方式  FF040100FF  FF040000FF
  96   1        {
  97   2            switch(buffer[1])
  98   2             {
  99   3                 case 0x01:
 100   3               MAINLIGHT_TURNON;
 101   3               break;
 102   3              case 0x00:
 103   3                MAINLIGHT_TURNOFF;
 104   3                break;
 105   3                default:return;
 106   3             }
 107   2                  
 108   2        }
 109   1        else if(buffer[0]==0x05)    //蜂鸣器
 110   1        {
 111   2            switch(buffer[1])
 112   2             {
 113   3                 case 0x01:
 114   3               MAINBUZZER_TURNON;
 115   3               break;
 116   3              case 0x00:
C51 COMPILER V9.54   UART                                                                  06/16/2015 09:53:32 PAGE 3   

 117   3                MAINBUZZER_TURNOFF;
 118   3                break;
 119   3                default:return;
 120   3             }
 121   2                  
 122   2        }
 123   1        else if(buffer[0]==0x50)    //遥控器红外接收(学习)
 124   1        {
 125   2          if((buffer[1]<5)&&(buffer[2]<10))
 126   2          {
 127   3            IR_Type = buffer[1];
 128   3            IR_Num = buffer[2];
 129   3            IR_Rec(); 
 130   3          }
 131   2          return;       
 132   2        }
 133   1        else if(buffer[0]==0x51)    //遥控器红外发射(控制)
 134   1        {
 135   2          if((buffer[1]<5)&&(buffer[2]<10))
 136   2          {
 137   3            IR_Type = buffer[1];
 138   3            IR_Num = buffer[2];
 139   3            IR_Tra(); 
 140   3          }
 141   2          return;       
 142   2        }
 143   1        else if(buffer[0]==0x13)//模式切换开关
 144   1        {
 145   2            switch(buffer[1])
 146   2          {
 147   3            case 0x01: 
 148   3              Cruising_Flag = 0x01; 
 149   3            break;//跟随
 150   3            case 0x02: 
 151   3              Cruising_Flag = 0x02; 
 152   3              LCD_P6x8Str(16,6,"Mode:Follow Line ");  
 153   3            break;//巡线
 154   3            case 0x03: 
 155   3              Cruising_Flag = 0x03; 
 156   3            break;//避障
 157   3            case 0x04: 
 158   3              Cruising_Flag = 0x04; 
 159   3            break;//雷达避障
 160   3            case 0x05: 
 161   3              Cruising_Flag = 0x05; 
 162   3            break;//机械臂演示
 163   3            case 0x06: 
 164   3              Cruising_Flag = 0x06;
 165   3            break;//摇头演示
 166   3            case 0x00: 
 167   3              Cruising_Flag = 0x00; 
 168   3              LCD_P6x8Str(16,6,"Mode:Normal      ");  
 169   3            break;//正常模式
 170   3            default:
 171   3              Cruising_Flag = 0x00; 
 172   3              LCD_P6x8Str(16,6,"Mode:Normal      ");  
 173   3            break;//正常模式
 174   3          }
 175   2        }
 176   1        else if(buffer[0]==0x32)//存储舵机角度
 177   1        {
 178   2            Earse_Section(50*512);
C51 COMPILER V9.54   UART                                                                  06/16/2015 09:53:32 PAGE 4   

 179   2          for(i=0;i<8;i++)
 180   2          {
 181   3            //Write_Byte(50*512+i,se_timer[i]); 
 182   3          }
 183   2        }
 184   1        else
 185   1        {
 186   2          return;
 187   2        }
 188   1      }
 189          
 190          void UART_Interrupt_Receive(void) interrupt 4
 191          {
 192   1        static uint8 i;
 193   1      
 194   1          if(RI==1)
 195   1          {
 196   2              RI  =   0;
 197   2              if(rec_flag==0)
 198   2          {
 199   3            if(SBUF==0xff)
 200   3            {
 201   4              rec_flag=1; 
 202   4              Uart_timeout_count = 0;
 203   4              i=0;
 204   4            }     
 205   3          }
 206   2          else
 207   2          {
 208   3            if(SBUF==0xff)
 209   3            { 
 210   4              rec_flag=0; 
 211   4              if(i==3)
 212   4              {
 213   5                Communication_Decode(); 
 214   5                //UART_init(); // 解决串口死机问题
 215   5              }
 216   4              i=0;
 217   4            }
 218   3            else
 219   3            {
 220   4              buffer[i]=SBUF;
 221   4              i++;
 222   4            }
 223   3          }   
 224   2          }
 225   1          else
 226   1          {
 227   2              TI  =  0;
 228   2          }
 229   1          
 230   1      }
*** WARNING C316 IN LINE 230 OF Source\uart.c: unterminated conditionals


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    687    ----
   CONSTANT SIZE    =     36    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.54   UART                                                                  06/16/2015 09:53:32 PAGE 5   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
