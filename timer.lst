C51 COMPILER V9.54   TIMER                                                                 06/16/2015 09:53:32 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN timer.obj
COMPILER INVOKED BY: d:\Keil_v5\C51\BIN\C51.EXE Source\timer.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\电机控制) DEBUG OBJECT
                    -EXTEND PRINT(.\timer.lst) TABS(2) OBJECT(timer.obj)

line level    source

   1            /*
   2          版权声明：
   3          WIFI机器人网・机器人创意工作室版权所有 www.wifi-robots.com
   4          您可以任意修改本程序，并应用于自行研发的智能小车机器人及其他电子产品上，但是禁止用于商业牟利。
   5          By WIFI机器人网・机器人创意工作室
   6          */
   7          #include "stc_new_8051.h"
   8          #include "timer.h"
   9          #include "steer.h"
  10          #include "IR.h"
  11          #include "MEM.h"
  12          
  13          uchar m=0,n=0;
  14          uchar Duty_left=80,Duty_right=80; //左右占空比标志，取1--100
  15          
  16          extern uint8 rec_flag;
  17          extern uint8 rec_flag;
  18          extern uint16 Sampling_cnt;
  19          extern bit IR_38K_En;
  20          extern bit IR_R_T; 
  21          extern bit IR_EN;
  22          uint16 Uart_timeout_count=0;
  23          extern void Steering_Engine_Control(void);
  24          uint16 se_timer[8]={SE1_Deg,SE2_Deg,SE3_Deg,SE4_Deg,SE5_Deg,SE6_Deg,SE7_Deg,SE8_Deg};
  25          /* ms 延时 */
  26          void Delay_Ms(uint32 t)
  27          {  
  28   1          uint16 i;
  29   1        while(t--)
  30   1        {
  31   2           for(i=0;i<1050;i++);
  32   2        }
  33   1      }
  34          
  35          void Timer0_Init(void)
  36          {
  37   1        TMOD   &=   0xf0; 
  38   1          TMOD   |=   0x01; 
  39   1        AUXR   |=   0XC0;
  40   1        IP   |=   0x02;//定时器0中断优先级最高
  41   1        TH0=(65536-66)/256;
  42   1         TL0=(65536-66)%256;
  43   1      
  44   1        TR0=1;
  45   1        ET0=1;
  46   1      }
  47          
  48          void Timer1_Init(void)
  49          {
  50   1          ET1     =   1;
  51   1          TMOD   &=   0x0f; 
  52   1          TMOD   |=   0x10;   
  53   1          TH1     =   0xA9;   //1MS定时
  54   1          TL1     =   0x9A;
C51 COMPILER V9.54   TIMER                                                                 06/16/2015 09:53:32 PAGE 2   

  55   1          TR1     =   1;    //开定时器1
  56   1      
  57   1      }
  58          
  59          void Timer_0(void) interrupt 1 
  60          {
  61   1        m++;            //调速在中断中执行
  62   1        n++;
  63   1        if(m<=Duty_left) 
  64   1           MOTOR_A_EN=1;
  65   1        else MOTOR_A_EN=0;  
  66   1        if(m>100) 
  67   1           {MOTOR_A_EN=1;m=0;}
  68   1        if(n<=Duty_right) 
  69   1           MOTOR_B_EN=1;
  70   1        else MOTOR_B_EN=0;
  71   1        if(n>100) 
  72   1           {MOTOR_B_EN=1;n=0;}
  73   1      TH0=(65536-66)/256;    //取约150HZ，12M晶振，每次定时66us，分100次，这样开头定义的变量正好直接表示占空比的
             -数值
  74   1      TL0=(65536-66)%256;
  75   1      
  76   1      }
  77          
  78          void Timer_1(void) interrupt 3
  79          {
  80   1          static uint16 ms_count=0;
  81   1      
  82   1        TH1     =   0xA9;   
  83   1          TL1     =   0x9A;
  84   1      
  85   1        Uart_timeout_count++;
  86   1        if((Uart_timeout_count == 1000) && (rec_flag)) //串口接收1秒超时
  87   1        {
  88   2          rec_flag = 0;
  89   2        }
  90   1      
  91   1        if(ms_count++ >= 1000)
  92   1        {
  93   2             ms_count = 0;
  94   2           if(rec_flag)
  95   2           {
  96   3               LED5 = ~LED5;
  97   3           }
  98   2           else
  99   2           {
 100   3               LED5 = 1;
 101   3           }
 102   2        }
 103   1        
 104   1      }
 105          void Init_Steer(void)
 106          {
 107   1        uint8 i;
 108   1      
 109   1        for(i=0;i<8;i++)
 110   1        {
 111   2          se_timer[i] = Read_Byte(50*512+i);  //100*512是舵机角度存储位置
 112   2        }
 113   1        
 114   1      }

C51 COMPILER V9.54   TIMER                                                                 06/16/2015 09:53:32 PAGE 3   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    266    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     24       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
